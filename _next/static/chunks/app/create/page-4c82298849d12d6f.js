(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[323],{854:(e,t,r)=>{"use strict";r.d(t,{A:()=>n});var l=r(4582);function n(){return(0,l.Z)()}},870:(e,t,r)=>{Promise.resolve().then(r.bind(r,2280))},2280:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>V});var l=r(5155),n=r(63),a=r(1847);let i=(0,a.A)("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]]);function s(e){let{isDragging:t,onChooseClick:r,onDragEnter:n,onDragLeave:a,onDrop:s}=e;return(0,l.jsxs)("div",{className:"image-workspace__dropzone".concat(t?" image-workspace__dropzone--active":""),onDragEnter:n,onDragOver:e=>e.preventDefault(),onDragLeave:a,onDrop:s,children:[(0,l.jsx)(i,{className:"image-workspace__dropzone-icon",strokeWidth:1.8}),(0,l.jsx)("p",{className:"image-workspace__dropzone-text",children:"Drag and drop images here"}),(0,l.jsx)("span",{className:"image-workspace__dropzone-separator",children:"or"}),(0,l.jsxs)("button",{type:"button",className:"image-workspace__choose",onClick:r,children:[(0,l.jsx)("span",{"aria-hidden":!0,className:"image-workspace__choose-icon",children:"+"}),"Choose Images"]})]})}var o=r(5239),c=r(2115);function u(e){let{lassoData:t,width:r,height:n}=e;return!t||r<=0||n<=0?null:(0,l.jsxs)("svg",{className:"image-workspace__lasso-overlay",viewBox:"0 0 ".concat(r," ").concat(n),preserveAspectRatio:"none",children:[t.closed&&(0,l.jsx)("path",{d:t.closed,className:"image-workspace__lasso-fill",fill:t.fill}),(0,l.jsx)("path",{d:t.path,className:"image-workspace__lasso-path",stroke:t.stroke,strokeWidth:2,strokeDasharray:"6 6",strokeLinecap:"round",strokeLinejoin:"round",fill:"none"}),(0,l.jsx)("circle",{className:"image-workspace__lasso-point",cx:t.start.x,cy:t.start.y,r:4,stroke:t.stroke,strokeWidth:2,fill:"#0f172a"}),(0,l.jsx)("circle",{className:"image-workspace__lasso-point",cx:t.end.x,cy:t.end.y,r:3,fill:t.stroke})]})}function d(e){var t,r,n,a;let{previewRef:i,imageRef:s,tintOverlayRef:d,selectedImage:h,imageTransform:f,isViewportPanning:m,isMaskToolActive:p,lassoPreview:g,onPointerDown:v,onPointerMove:y,onPointerUp:x,onWheel:b,children:k}=e,w=null!=(n=null==(t=i.current)?void 0:t.clientWidth)?n:0,_=null!=(a=null==(r=i.current)?void 0:r.clientHeight)?a:0,j=(0,c.useMemo)(()=>{if(!(null==g?void 0:g.points.length))return null;let e=g.points.map((e,t)=>"".concat(0===t?"M":"L"," ").concat(e.x," ").concat(e.y)).join(" ");return{path:e,closed:g.points.length>2?"".concat(e," Z"):null,stroke:"erase"===g.tool?"rgba(248,113,113,0.9)":"rgba(56,189,248,0.9)",fill:"erase"===g.tool?"rgba(248,113,113,0.08)":"rgba(56,189,248,0.08)",start:g.points[0],end:g.points[g.points.length-1]}},[g]);return(0,l.jsxs)("div",{className:"image-workspace__gallery",children:[(0,l.jsx)("div",{ref:i,className:"image-workspace__preview".concat(m?" image-workspace__preview--panning":"").concat(p?" image-workspace__preview--mask":""),onPointerDown:v,onPointerMove:y,onPointerUp:x,onPointerLeave:x,onPointerCancel:x,onWheel:b,onContextMenu:e=>e.preventDefault(),children:(0,l.jsxs)("div",{className:"image-workspace__preview-layer",children:[(0,l.jsx)(o.default,{ref:s,src:h.url,alt:h.name,fill:!0,unoptimized:!0,sizes:"100vw",style:{transform:f,objectFit:"contain"}}),(0,l.jsx)("canvas",{ref:d,className:"image-workspace__mask-overlay","aria-hidden":!0}),(0,l.jsx)(u,{lassoData:j,width:w,height:_})]})}),k]})}let h=(0,a.A)("move-3d",[["path",{d:"M5 3v16h16",key:"1mqmf9"}],["path",{d:"m5 19 6-6",key:"jh6hbb"}],["path",{d:"m2 6 3-3 3 3",key:"tkyvxa"}],["path",{d:"m18 16 3 3-3 3",key:"1d4glt"}]]),f=(0,a.A)("rotate-3d",[["path",{d:"M16.466 7.5C15.643 4.237 13.952 2 12 2 9.239 2 7 6.477 7 12s2.239 10 5 10c.342 0 .677-.069 1-.2",key:"10n0gc"}],["path",{d:"m15.194 13.707 3.814 1.86-1.86 3.814",key:"16shm9"}],["path",{d:"M19 15.57c-1.804.885-4.274 1.43-7 1.43-5.523 0-10-2.239-10-5s4.477-5 10-5c4.838 0 8.873 1.718 9.8 4",key:"1lxi77"}]]),m=(0,a.A)("eraser",[["path",{d:"M21 21H8a2 2 0 0 1-1.42-.587l-3.994-3.999a2 2 0 0 1 0-2.828l10-10a2 2 0 0 1 2.829 0l5.999 6a2 2 0 0 1 0 2.828L12.834 21",key:"g5wo59"}],["path",{d:"m5.082 11.09 8.828 8.828",key:"1wx5vj"}]]),p=(0,a.A)("brush",[["path",{d:"m11 10 3 3",key:"fzmg1i"}],["path",{d:"M6.5 21A3.5 3.5 0 1 0 3 17.5a2.62 2.62 0 0 1-.708 1.792A1 1 0 0 0 3 21z",key:"p4q2r7"}],["path",{d:"M9.969 17.031 21.378 5.624a1 1 0 0 0-3.002-3.002L6.967 14.031",key:"wy6l02"}]]),g=(0,a.A)("hand",[["path",{d:"M18 11V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2",key:"1fvzgz"}],["path",{d:"M14 10V4a2 2 0 0 0-2-2a2 2 0 0 0-2 2v2",key:"1kc0my"}],["path",{d:"M10 10.5V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2v8",key:"10h0bg"}],["path",{d:"M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15",key:"1s1gnw"}]]),v=(0,a.A)("eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),y=(0,a.A)("eye-off",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]),x=(0,a.A)("undo-2",[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11",key:"f3b9sd"}]]);var b=r(5993);let k={hand:"Pan/zoom image",translate:"Move/scale selection rectangle",rotate:"Rotate selection rectangle",erase:"Mask (hide) parts of image",restore:"Restore masked parts",none:"Select a tool"},w=[{id:"translate",icon:h,label:"Translate",description:k.translate},{id:"rotate",icon:f,label:"Rotate",description:k.rotate}],_=[{id:"erase",icon:m,label:"Erase",description:k.erase},{id:"restore",icon:p,label:"Restore",description:k.restore}],j=e=>{let{icon:t,active:r,disabled:n,onClick:a,title:i}=e;return(0,l.jsx)("button",{type:"button",className:"toolbar__button".concat(r?" toolbar__button--active":"").concat(n?" toolbar__button--disabled":""),onClick:a,title:i,disabled:n,children:(0,l.jsx)(t,{className:"toolbar__icon",strokeWidth:1.9})})};function C(e){let{activeTool:t,onToolChange:r,onUndo:n,canUndo:a,onResetViewport:i,canResetViewport:s,modifierActive:o=!1,maskVisible:c=!0,onToggleMaskVisible:u,tempActiveTool:d=null,gridEnabled:h=!0,selectionVisible:f=!0,onToggleSelectionVisible:m,isReportSubmitting:p=!1}=e,C=e=>{if(e===t)return void r("hand");r(e)};return(0,l.jsxs)("header",{className:"toolbar",children:[(0,l.jsx)("div",{className:"toolbar__group",children:(0,l.jsx)(j,{icon:g,active:o||"hand"===t,onClick:()=>C("hand"),title:k.hand})}),(0,l.jsxs)("div",{className:"toolbar__group",children:[(0,l.jsx)("span",{className:"toolbar__group-label",children:"Grid:"}),w.map(e=>{let{id:r,icon:n,description:a}=e;return(0,l.jsx)(j,{icon:n,active:d?d===r:!o&&t===r,disabled:!h||p,onClick:()=>h&&!p&&C(r),title:p?"Disabled during report creation":a},r)}),(0,l.jsx)(j,{icon:f?v:y,disabled:!h,onClick:()=>h&&(null==m?void 0:m(!f)),title:f?"Hide selection rectangle":"Show selection rectangle"})]}),(0,l.jsx)("span",{className:"toolbar__divider"}),(0,l.jsxs)("div",{className:"toolbar__group",children:[(0,l.jsx)("span",{className:"toolbar__group-label",children:"Mask:"}),_.map(e=>{let{id:r,icon:n,description:a}=e;return(0,l.jsx)(j,{icon:n,active:d?d===r:!o&&t===r,disabled:p,onClick:()=>!p&&C(r),title:p?"Disabled during report creation":a},r)}),(0,l.jsx)(j,{icon:c?v:y,onClick:()=>null==u?void 0:u(!c),title:c?"Hide mask overlay":"Show mask overlay"})]}),(0,l.jsx)("span",{className:"toolbar__divider"}),(0,l.jsxs)("div",{className:"toolbar__group",children:[(0,l.jsx)(j,{icon:x,disabled:!a||p,onClick:n,title:p?"Disabled during report creation":"Undo"}),(0,l.jsx)(j,{icon:b.A,disabled:!s,onClick:i,title:"Reset viewport"})]}),(0,l.jsx)("div",{className:"toolbar__status",children:k[t]})]})}function M(e){let{image:t,active:r,onSelect:n,onRemove:a}=e;return(0,l.jsxs)("div",{className:"image-workspace__thumb".concat(r?" image-workspace__thumb--active":""),role:"listitem",children:[(0,l.jsx)("button",{type:"button",className:"image-workspace__thumb-select",onClick:()=>n(t.id),onKeyDown:e=>"Delete"===e.key&&(e.preventDefault(),a(t.id)),children:(0,l.jsx)(o.default,{src:t.url,alt:t.name,width:64,height:64,unoptimized:!0,className:"image-workspace__thumb-image"})}),(0,l.jsx)("button",{type:"button",className:"image-workspace__thumb-remove",onClick:e=>{e.stopPropagation(),a(t.id)},"aria-label":"Remove ".concat(t.name),children:"\xd7"})]})}function N(e){let{images:t,selectedId:r,onSelect:n,onRemove:a,onAdd:i,isReportSubmitting:s=!1}=e;return(0,l.jsxs)("ul",{className:"image-workspace__thumbs",role:"list",children:[t.map(e=>(0,l.jsx)("li",{children:(0,l.jsx)(M,{image:e,active:e.id===r,onSelect:n,onRemove:a})},e.id)),(0,l.jsx)("li",{children:(0,l.jsx)("button",{type:"button",className:"image-workspace__thumb image-workspace__thumb--add".concat(s?" image-workspace__thumb--disabled":""),onClick:s?void 0:i,disabled:s,"aria-label":s?"Adding images disabled during report creation":"Add new image",children:(0,l.jsx)("span",{"aria-hidden":!0,className:"image-workspace__thumb-add",children:"+"})})})]})}let R=["erase","restore"],S=()=>"undefined"!=typeof performance?performance.now():Date.now();class I{addDrawer(e){this.drawers.push(e)}clear(){this.drawers.length=0}compose(e,t,r){for(let l of this.drawers)try{l(e,t,r)}catch(e){}}constructor(){this.drawers=[]}}function A(){return{x:0,y:0,z:0,w:1}}let D=()=>({scale:.95,offset:{x:0,y:0}});function E(e){return null!=e&&"object"==typeof e&&Object.prototype.hasOwnProperty.call(e,"sel")}function T(e){var t;let{gridEnabled:r=!1,dimensions:n,onImagesChange:a,onImages:i,isReportSubmitting:o=!1}=e,{library:u,activeTool:h,setActiveTool:f,handleViewportPointerDown:m,handleViewportPointerMove:p,handleViewportPointerUp:g,handleWheel:v,previewRef:y,imageRef:x,tintOverlayRef:b,forceRedraw:k,lassoPreview:w,isMaskToolActive:_,isViewportDefault:j,resetViewport:M,isViewportPanning:T,imageTransform:z,modifierActive:P,tempToolOverride:L,maskVisible:O,setMaskVisible:W,undo:U,canUndo:F,setSelectionDimensions:H,selectionVisible:V,setSelectionVisible:q,getMaskCanvas:Y,getSelectionState:B,getSelectionForImage:X,getOverlayMetrics:K,selectionState:Z,overlayVersion:G}=function(){var e,t,r,l,n,a;let i=function(){let[e,t]=(0,c.useState)([]),[r,l]=(0,c.useState)(null),[n,a]=(0,c.useState)(!1),i=(0,c.useRef)(null),s=(0,c.useRef)(new Map),o=(0,c.useRef)(0),u=(0,c.useMemo)(()=>{var t;return e.length?null!=(t=e.find(e=>e.id===r))?t:e[0]:null},[e,r]),d=(0,c.useCallback)(e=>{let r=Array.from(e).filter(e=>e.type.startsWith("image/"));if(!r.length)return;let n=r.map(e=>{let t="undefined"!=typeof crypto&&"randomUUID"in crypto?crypto.randomUUID():"".concat(Date.now(),"-").concat(Math.random().toString(16).slice(2)),r=URL.createObjectURL(e);return s.current.set(t,r),{id:t,name:e.name,url:r,file:e}});t(e=>[...e,...n]),l(e=>{var t,r;return null!=(r=null!=e?e:null==(t=n[0])?void 0:t.id)?r:null})},[]),h=(0,c.useCallback)(e=>{t(t=>{let n=t.find(t=>t.id===e);if(!n)return t;URL.revokeObjectURL(n.url),s.current.delete(e);let a=t.filter(t=>t.id!==e);return a.length?e===r&&l(a[0].id):l(null),a})},[r]),f=(0,c.useCallback)(()=>{t(e=>(e.forEach(e=>URL.revokeObjectURL(e.url)),s.current.clear(),[])),l(null)},[]),m=(0,c.useCallback)(e=>{e.target.files&&d(e.target.files),e.target.value=""},[d]),p=(0,c.useCallback)(()=>{var e;null==(e=i.current)||e.click()},[]),g=(0,c.useCallback)(e=>{e.preventDefault(),o.current+=1,a(!0)},[]),v=(0,c.useCallback)(e=>{e.preventDefault(),o.current=Math.max(0,o.current-1),0===o.current&&a(!1)},[]),y=(0,c.useCallback)(e=>{e.preventDefault(),o.current=0,a(!1),e.dataTransfer.files.length>0&&d(e.dataTransfer.files)},[d]);return(0,c.useEffect)(()=>()=>{s.current.forEach(e=>URL.revokeObjectURL(e)),s.current.clear()},[]),{images:e,selectedId:r,selectedImage:u,setSelectedId:l,fileInputRef:i,isDragging:n,addFiles:d,removeImage:h,clearImages:f,handleFileInputChange:m,handleChooseClick:p,handleDragEnter:g,handleDragLeave:v,handleDrop:y}}(),[s,o]=(0,c.useState)("hand"),[u,d]=(0,c.useState)(!1),[h,f]=(0,c.useState)(null),m=(0,c.useRef)(null),p=(0,c.useRef)(null),g=(0,c.useRef)(new Map),v=(0,c.useRef)(!1),[y,x]=(0,c.useState)(!1),[b,k]=(0,c.useState)(!0),[w,_]=(0,c.useState)(!0),[j,C]=(0,c.useState)(null),M=(0,c.useRef)([]),N=(0,c.useRef)([]),[E,T]=(0,c.useState)(!1),z=(0,c.useCallback)(e=>{M.current.push(e),N.current.length=0,T(!0)},[]),P=(0,c.useCallback)(()=>N.current.length>0,[]),L=(0,c.useCallback)(()=>{let e=M.current.pop();if(e)try{e.undo(),e.redo&&N.current.push(e),T(M.current.length>0)}catch(e){}},[]),O=(0,c.useCallback)(()=>{let e=N.current.pop();if(e)try{e.redo&&e.redo(),M.current.push(e),T(!0)}catch(e){}},[]),{isMaskTool:W,handlePointerDown:U,handlePointerMove:F,handlePointerUp:H,handleToolChange:V,lassoPreview:q,overlayVersion:Y,getTintOverlay:B,getMaskCanvas:X}=function(e){let{images:t,selectedImageId:r,previewRef:l,imageRef:n,onToggleViewportPanning:a,onPushUndo:i}=e,s=(0,c.useRef)(new Map),o=(0,c.useRef)(null),[u,d]=(0,c.useState)(null),[h,f]=(0,c.useState)(0),m=(0,c.useCallback)(e=>R.includes(e),[]),p=(0,c.useCallback)((e,t)=>{var r,a,i;let o=n.current,c=s.current.get(t);if(!o||!(null==c?void 0:c.width)||!(null==c?void 0:c.height))return null;let u=null!=(i=null==(r=o.parentElement)?void 0:r.getBoundingClientRect())?i:null==(a=l.current)?void 0:a.getBoundingClientRect();if(!u||!u.width||!u.height)return null;let d=c.width,h=c.height,f=Math.min(u.width/d,u.height/h);if(!Number.isFinite(f)||f<=0)return null;let m=(u.width-d*f)/2,p=(u.height-h*f)/2,g=e.clientX-u.left,v=e.clientY-u.top,y=g,x=v;try{let e=getComputedStyle(o).transform||"none";if("none"!==e){let t=new DOMMatrixReadOnly(e).inverse().transformPoint(new DOMPoint(g,v));y=t.x,x=t.y}}catch(e){}return{x:Math.max(0,Math.min(d,(y-m)/f)),y:Math.max(0,Math.min(h,(x-p)/f))}},[n,l]),g=(0,c.useCallback)(e=>{var t;let r=null==(t=l.current)?void 0:t.getBoundingClientRect();return r?{x:e.clientX-r.left,y:e.clientY-r.top}:null},[l]),v=(0,c.useCallback)(e=>{let{tintCtx:t,width:r,height:l,mask:n}=e;t&&r&&l&&(t.save(),t.clearRect(0,0,r,l),t.fillStyle="#fff",t.fillRect(0,0,r,l),t.globalCompositeOperation="destination-out",t.drawImage(n,0,0),t.restore())},[]),y=(0,c.useCallback)((e,t,r)=>{if(r.length<3)return;let l=s.current.get(e);if(!l)return;let{maskCtx:n}=l,a=null,o=null;try{a=n.getImageData(0,0,l.width,l.height)}catch(e){a=null}n.save(),n.beginPath(),n.moveTo(r[0].x,r[0].y),r.forEach((e,t)=>t&&n.lineTo(e.x,e.y)),n.closePath(),n.globalCompositeOperation="erase"===t?"destination-out":"source-over",n.fillStyle="erase"===t?"#000":"#fff",n.fill(),n.restore();try{o=n.getImageData(0,0,l.width,l.height)}catch(e){o=null}if(i&&a){let r={undo:()=>{let t=s.current.get(e);if(!t)return;let r=t.maskCtx;try{r.putImageData(a,0,0),v(t),f(e=>e+1)}catch(e){}},redo:o?()=>{let t=s.current.get(e);if(!t)return;let r=t.maskCtx;try{r.putImageData(o,0,0),v(t),f(e=>e+1)}catch(e){}}:void 0,description:"Mask: ".concat(t)};try{i(r)}catch(e){}}v(l),f(e=>e+1)},[v,i]),x=(0,c.useCallback)(()=>{var e;let t=o.current;t&&(null==(e=l.current)||e.releasePointerCapture(t.pointerId),o.current=null,d(null),a(!1))},[a,l]),b=(0,c.useCallback)((e,t)=>{var n;if(!m(t)||0!==e.button&&2!==e.button||!r)return!1;let i=2===e.button?"erase"===t?"restore":"erase":t,s=p(e,r),c=g(e);if(!s||!c)return!1;try{e.preventDefault()}catch(e){}return null==(n=l.current)||n.setPointerCapture(e.pointerId),o.current={pointerId:e.pointerId,tool:i,imageId:r,points:[s],previewPoints:[c],lastInsertTime:S()},a(!1),d({tool:i,points:[c]}),!0},[p,g,m,a,l,r]),k=(0,c.useCallback)(e=>{let t=o.current;if(!t||t.pointerId!==e.pointerId)return!1;e.preventDefault();let r=p(e,t.imageId),l=g(e);if(!r||!l)return!0;let n=t.points[t.points.length-1],a=r.x-n.x,i=r.y-n.y,s=S()-t.lastInsertTime;return(a*a+i*i>=1||s>=45)&&(t.points.push(r),t.previewPoints.push(l),t.lastInsertTime=S(),d({tool:t.tool,points:[...t.previewPoints]})),!0},[p,g]),w=(0,c.useCallback)(e=>{let t=o.current;return!!t&&t.pointerId===e.pointerId&&(y(t.imageId,t.tool,t.points),x(),!0)},[y,x]),_=(0,c.useCallback)(()=>{x(),f(e=>e+1)},[x]);(0,c.useEffect)(()=>{let e=r?t.find(e=>e.id===r):null;if(!e||s.current.get(e.id))return;let l=new Image;l.src=e.url,l.crossOrigin="anonymous";let n=()=>{let t=l.naturalWidth,r=l.naturalHeight;if(!t||!r)return;let n=document.createElement("canvas");n.width=t,n.height=r;let a=n.getContext("2d"),i=document.createElement("canvas");i.width=t,i.height=r;let o=i.getContext("2d");a&&o&&(a.fillStyle="#fff",a.fillRect(0,0,t,r),s.current.set(e.id,{image:l,width:t,height:r,mask:n,maskCtx:a,tint:i,tintCtx:o}),v({image:l,width:t,height:r,mask:n,maskCtx:a,tint:i,tintCtx:o}),f(e=>e+1))};return l.addEventListener("load",n),()=>l.removeEventListener("load",n)},[t,r,v]),(0,c.useEffect)(()=>()=>x(),[x]);let j=(0,c.useCallback)(e=>{var t,l;let n=null!=e?e:r;return n&&null!=(l=null==(t=s.current.get(n))?void 0:t.tint)?l:null},[r]);return{isMaskTool:m,handlePointerDown:b,handlePointerMove:k,handlePointerUp:w,handleToolChange:_,lassoPreview:u,overlayVersion:h,getTintOverlay:j,getMaskCanvas:(0,c.useCallback)(e=>{var t,l;let n=null!=e?e:r;return n&&null!=(l=null==(t=s.current.get(n))?void 0:t.mask)?l:null},[r]),getBooleanMask:(0,c.useCallback)(e=>{var t;let l=null!=e?e:r;if(!l)return null;let n=null==(t=s.current.get(l))?void 0:t.mask;if(!n)return null;let a=n.getContext("2d");if(!a)return null;let{width:i,height:o}=n,{data:c}=a.getImageData(0,0,i,o),u=new Uint8Array(i*o);for(let e=0;e<c.length;e+=4)u[e/4]=+(c[e+3]>0);return{width:i,height:o,data:u}},[r])}}({images:i.images,selectedImageId:null!=(l=null==(e=i.selectedImage)?void 0:e.id)?l:null,previewRef:m,imageRef:p,onToggleViewportPanning:d,onPushUndo:z}),{tintOverlayRef:K,updateFromViewport:Z,forceRedraw:G,markDirty:$,setSelectionDimensions:J,handleSelectionPointerDown:Q,handleSelectionPointerMove:ee,handleSelectionPointerUp:et,getSelectionState:er,handleSelectionWheel:el,getSelectionForImage:en,getOverlayMetrics:ea}=function(e){let{previewRef:t,imageRef:r,getTintOverlay:l,maskVisible:n=!0,selectionVisible:a=!0,selectedImageId:i=null,onSelectionChange:s,onPushUndo:o}=e,u=(0,c.useRef)(null),d=(0,c.useRef)(new Map),h=(0,c.useRef)(!1),f=(0,c.useRef)(null),m=(0,c.useRef)(!1),p=(0,c.useRef)(null),g=(0,c.useRef)(!1),v=(0,c.useRef)(null),y=(0,c.useRef)(null),x=(0,c.useRef)(!1),b=(0,c.useRef)({scale:1,offset:{x:0,y:0}}),k=(0,c.useRef)(null),w=(0,c.useRef)(null),_=(0,c.useCallback)((e,t,r,l,n)=>{let a=(e-r)/n,i=(t-l)/n,s=a*a+i*i;if(!(s>1))return{x:a,y:i,z:Math.sqrt(1-s)};{let e=1/Math.sqrt(s);return{x:a*e,y:i*e,z:0}}},[]),j="k9.selection.",C=(0,c.useCallback)((e,t)=>{try{t&&t.dimensions?localStorage.setItem(j+e,JSON.stringify(t)):localStorage.removeItem(j+e)}catch(e){}},[]),M=(0,c.useCallback)(e=>{try{let t=localStorage.getItem(j+e);if(!t)return null;return JSON.parse(t)}catch(e){return null}},[]),N=(0,c.useCallback)(()=>{if(!i)return null;let e=d.current.get(i)||null;if(!e){let t=M(i);t&&(e=t,d.current.set(i,e))}return e},[i,M]),R=(0,c.useCallback)(()=>{var e,n,a,i;let s=u.current,o=t.current,c=r.current;if(!s||!o||!c)return{metrics:null,sizeChanged:!1};let d=l(),h=null!=(n=null==d?void 0:d.width)?n:c.naturalWidth,f=null!=(a=null==d?void 0:d.height)?a:c.naturalHeight;if(!h||!f)return s.style.opacity="0",y.current=null,{metrics:null,sizeChanged:!1};let m=null!=(i=null==(e=s.parentElement)?void 0:e.getBoundingClientRect())?i:o.getBoundingClientRect();if(!m.width||!m.height)return s.style.opacity="0",y.current=null,{metrics:null,sizeChanged:!1};let p=Math.min(m.width/h,m.height/f);if(!Number.isFinite(p)||p<=0)return s.style.opacity="0",y.current=null,{metrics:null,sizeChanged:!1};let g=h*p,v=f*p,x={left:(m.width-g)/2,top:(m.height-v)/2,width:g,height:v,containerWidth:m.width,containerHeight:m.height};s.style.left="0px",s.style.top="0px",s.style.width="".concat(Math.ceil(x.containerWidth),"px"),s.style.height="".concat(Math.ceil(x.containerHeight),"px");try{s.style.transformOrigin="top left",s.style.transform=c.style.transform||""}catch(e){}let b=y.current,k=!b||Math.abs(b.width-x.width)>.5||Math.abs(b.height-x.height)>.5||Math.abs(b.left-x.left)>.5||Math.abs(b.top-x.top)>.5;return y.current=x,{metrics:x,sizeChanged:k}},[l,r,t]),S=(0,c.useCallback)(function(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=u.current,o=l();if(!s||!e){x.current=!1,s&&(s.style.opacity="0");return}let c=window.devicePixelRatio||1,d=Math.max(e.containerWidth*c,e.containerHeight*c),h=c*(d>4096?4096/d:1),f=Math.max(1,Math.ceil(e.containerWidth*h)),m=Math.max(1,Math.ceil(e.containerHeight*h));if(s.width!==f||s.height!==m)s.width=f,s.height=m,i=!0;else if(!i&&x.current)return;let p=s.getContext("2d");if(!p)return;p.setTransform(1,0,0,1,0,0),p.clearRect(0,0,s.width,s.height),p.save();let g=f/e.containerWidth,v=m/e.containerHeight;p.setTransform(g,0,0,v,0,0);try{let l=r.current,i=w.current;i&&i.compose(p,e,{tint:o,img:l,maskVisible:n,selectionVisible:a,scale:t})}catch(e){}p.restore(),s.style.opacity="1",x.current=!0},[l,n,a,r]),D=(0,c.useCallback)(()=>{let e=b.current,{metrics:t}=R();t&&S(t,e.scale,!0)},[R,S]),E=(0,c.useCallback)(e=>{if(i){e?(d.current.set(i,e),C(i,e)):(d.current.delete(i),C(i,null));try{let t=e?{sel:e.dimensions,offset:e.transform.offset,scale:e.transform.scale,rotation:e.transform.rotation}:null;null==s||s(t)}catch(e){}k.current&&cancelAnimationFrame(k.current),k.current=requestAnimationFrame(()=>{D(),k.current=null})}},[i,C,s,D]),T=(0,c.useCallback)((e,t,r)=>{if(!e||!e.length||!e.width)return null;let l=e.length/e.width,n=.3*Math.min(r.width,r.height),a=n,i=n/l;i>n&&(i=n,a=n*l),a*=t.scale,i*=t.scale;let s=r.left+r.width/2+t.offset.x,o=r.top+r.height/2+t.offset.y;return{x:s-a/2,y:o-i/2,width:a,height:i,centerX:s,centerY:o}},[]);(0,c.useEffect)(()=>{let e=new I;return e.addDrawer((e,t,r)=>{try{var l,n;!function(e,t,r,l){let n=!(arguments.length>4)||void 0===arguments[4]||arguments[4];if(e){if(e.save(),n){e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(0,0,t.containerWidth,t.containerHeight);let l=function(){let e=document.createElement("canvas");e.width=30,e.height=30;let t=e.getContext("2d");return t?(t.clearRect(0,0,30,30),t.strokeStyle="rgba(255, 255, 255, 0.8)",t.lineWidth=4,t.lineCap="round",t.beginPath(),t.moveTo(-15,30),t.lineTo(30,-15),t.stroke(),t.beginPath(),t.moveTo(0,45),t.lineTo(45,0),t.stroke(),e):null}();if(l){let r=e.createPattern(l,"repeat");r&&(e.globalAlpha=.5,e.fillStyle=r,e.fillRect(0,0,t.containerWidth,t.containerHeight),e.globalAlpha=1)}e.globalCompositeOperation="destination-in";let n=Math.round(t.left),a=Math.round(t.top),i=Math.round(t.width),s=Math.round(t.height);r&&r.width&&r.height&&e.drawImage(r,0,0,r.width,r.height,n,a,i,s)}else if(l){let n=Math.round(t.left),a=Math.round(t.top),i=Math.round(t.width),s=Math.round(t.height);try{e.drawImage(l,0,0,l.naturalWidth,l.naturalHeight,n,a,i,s),r&&r.width&&r.height&&(e.globalCompositeOperation="destination-out",e.drawImage(r,0,0,r.width,r.height,n,a,i,s),e.globalCompositeOperation="source-over")}catch(e){}}e.restore()}}(e,t,null!=(l=null==r?void 0:r.tint)?l:null,null!=(n=null==r?void 0:r.img)?n:null,!!(null==r?void 0:r.maskVisible))}catch(e){}}),e.addDrawer((e,t,r)=>{if(!(null==r?void 0:r.selectionVisible))return;let l=N();if(l&&l.dimensions)try{let r={sel:l.dimensions,offset:l.transform.offset,scale:l.transform.scale,rotation:l.transform.rotation};!function(e,t,r){var l,n,a,i,s,o;if(!r)return;let c=r.sel;if(!c||!c.length||!c.width)return;if(r.rotation){let l=function(e,t,r){let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:800,n=function(e,t){var r,l,n,a,i,s;if(!e||!t)return null;let o=t.sel;if(!o||!o.length||!o.width)return null;let c=Math.max(o.length,o.width)/Math.min(o.length,o.width),u=e.width,d=e.height,h=.22*Math.min(u,d),f=c*h;f>u&&(h=(f=.9*u)/c),h>d&&(f=(h=.9*d)*c);let m=e.left+(u-f)/2,p=e.top+(d-h)/2,g=m+f/2,v=p+h/2;return f*=null!=(n=t.scale)?n:1,h*=null!=(a=t.scale)?a:1,{x:m=g-f/2+(null!=(i=null==(r=t.offset)?void 0:r.x)?i:0),y:p=v-h/2+(null!=(s=null==(l=t.offset)?void 0:l.y)?s:0),w:f,h,cx:m+f/2,cy:p+h/2}}(e,t);if(!n)return null;let a=null!=r?r:t&&t.rotation?t.rotation:A(),i=n.w/2,s=n.h/2,o=[{x:-i,y:-s,z:0},{x:+i,y:-s,z:0},{x:+i,y:+s,z:0},{x:-i,y:+s,z:0}].map(e=>(function(e,t){let r=t.x,l=t.y,n=t.z,a=e.x,i=e.y,s=e.z,o=e.w,c=2*(i*n-s*l),u=2*(s*r-a*n),d=2*(a*l-i*r);return{x:r+o*c+(i*d-s*u),y:l+o*u+(s*c-a*d),z:n+o*d+(a*u-i*c)}})(a,e));return{corners2D:o.map(e=>(function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:800,l=r/(r-e.z);return{x:t.x+e.x*l,y:t.y+e.y*l}})(e,{x:n.cx,y:n.cy},l)),corners3D:o,center:{x:n.cx,y:n.cy}}}(t,r);if(l){let t=l.corners2D;e.save(),e.strokeStyle="rgba(56,189,248,0.9)",e.fillStyle="rgba(56,189,248,0.08)",e.lineWidth=2,e.beginPath(),e.moveTo(Math.round(t[0].x),Math.round(t[0].y));for(let r=1;r<t.length;r++)e.lineTo(Math.round(t[r].x),Math.round(t[r].y));e.closePath(),e.fill(),e.stroke(),e.restore();return}}let u=Math.max(c.length,c.width)/Math.min(c.length,c.width),d=t.width,h=t.height,f=.22*Math.min(d,h),m=u*f;m>d&&(f=(m=.9*d)/u),f>h&&(m=(f=.9*h)*u);let p=t.left+(d-m)/2,g=t.top+(h-f)/2,v=p+m/2,y=g+f/2;m*=null!=(a=r.scale)?a:1,f*=null!=(i=r.scale)?i:1,p=v-m/2+(null!=(s=null==(l=r.offset)?void 0:l.x)?s:0),g=y-f/2+(null!=(o=null==(n=r.offset)?void 0:n.y)?o:0),e.save(),e.fillStyle="rgba(56,189,248,0.08)",e.strokeStyle="rgba(56,189,248,0.9)",e.lineWidth=2,e.fillRect(Math.round(p),Math.round(g),Math.round(m),Math.round(f)),e.strokeRect(Math.round(p)+1,Math.round(g)+1,Math.round(m)-2,Math.round(f)-2),e.restore()}(e,t,r)}catch(e){}}),w.current=e,()=>{w.current=null}},[N]);let z=(0,c.useCallback)(e=>{b.current=e;let{metrics:t,sizeChanged:r}=R();t&&S(t,e.scale,r)},[S,R]),P=(0,c.useCallback)(()=>{x.current=!1;let e=u.current;e&&(e.style.opacity="0")},[]),L=(0,c.useCallback)(e=>{var t;if(!e||!e.length&&!e.width)return void E(null);let r=N();E({dimensions:e,transform:null!=(t=null==r?void 0:r.transform)?t:{offset:{x:0,y:0},scale:1,rotation:A()}})},[N,E]),O=(0,c.useCallback)((e,r)=>{if(0!==e.button&&2!==e.button)return!1;let l=N();if(!l||!l.dimensions)return!1;let n=y.current;if(!n)return!1;let a=T(l.dimensions,l.transform,n);if(!a)return!1;try{var i;null==(i=t.current)||i.setPointerCapture(e.pointerId)}catch(e){}if("translate"===r)return h.current=!0,f.current={x:e.clientX,y:e.clientY,transform:{...l.transform},initialState:{...l}},!0;if("rotate"===r){g.current=!0;let t=u.current,r=null==t?void 0:t.getBoundingClientRect();if(!r)return!1;let n=y.current;if(!n)return!1;let i=r.width/n.containerWidth,s=r.height/n.containerHeight,o=r.left+a.centerX*i,c=r.top+a.centerY*s,d=.75*Math.min(a.width*i,a.height*s),h=_(e.clientX,e.clientY,o,c,d);return v.current={rotation:{...l.transform.rotation},center:{x:o,y:c},radius:d,startPoint3D:h,initialState:{...l}},!0}return!1},[N,T,t,_]),W=(0,c.useCallback)(e=>{let t=N();if(!t)return!1;if(h.current&&f.current){e.preventDefault();let r=e.clientX-f.current.x,l=e.clientY-f.current.y,n=b.current.scale,a={...t.transform,offset:{x:f.current.transform.offset.x+r/n,y:f.current.transform.offset.y+l/n}};return E({...t,transform:a}),!0}if(g.current&&v.current){e.preventDefault();let r=v.current.center,l=v.current.radius,n=v.current.startPoint3D,a=_(e.clientX,e.clientY,r.x,r.y,l),i={x:n.y*a.z-n.z*a.y,y:n.z*a.x-n.x*a.z,z:n.x*a.y-n.y*a.x},s=n.x*a.x+n.y*a.y+n.z*a.z,o=Math.sqrt(i.x*i.x+i.y*i.y+i.z*i.z);if(o>1e-6){let e={x:i.x/o,y:i.y/o,z:i.z/o},r=.5*Math.atan2(o,s),l=Math.sin(r),n=function(e){let t=Math.hypot(e.x,e.y,e.z,e.w)||1;return{x:e.x/t,y:e.y/t,z:e.z/t,w:e.w/t}}(function(e,t){let r=e.w*t.x+e.x*t.w+e.y*t.z-e.z*t.y,l=e.w*t.y-e.x*t.z+e.y*t.w+e.z*t.x;return{x:r,y:l,z:e.w*t.z+e.x*t.y-e.y*t.x+e.z*t.w,w:e.w*t.w-e.x*t.x-e.y*t.y-e.z*t.z}}({x:e.x*l,y:e.y*l,z:e.z*l,w:Math.cos(r)},v.current.rotation)),a={...t.transform,rotation:n};E({...t,transform:a})}return!0}return!1},[N,E,_]),U=(0,c.useCallback)(e=>{var r,l,n,a;if(!h.current&&!g.current&&!m.current)return!1;try{null==(r=t.current)||r.releasePointerCapture(e.pointerId)}catch(e){}let s=h.current||g.current||m.current;if(s&&o&&i){let e=N();if(e){let t=null,r="";if(h.current&&(null==(l=f.current)?void 0:l.initialState)?(t=f.current.initialState,r="Move selection"):g.current&&(null==(n=v.current)?void 0:n.initialState)?(t=v.current.initialState,r="Rotate selection"):m.current&&(null==(a=p.current)?void 0:a.initialState)&&(t=p.current.initialState,r="Scale selection"),t){let l={...e};o({description:r,undo:()=>E(t),redo:()=>E(l)})}}}return h.current=!1,g.current=!1,m.current=!1,f.current=null,v.current=null,p.current=null,s},[N,E,o,i,t]),F=(0,c.useCallback)(e=>{let t=N();if(!t)return!1;e.preventDefault(),m.current||(m.current=!0,p.current={scale:t.transform.scale,initialState:t});let r=Math.exp(-(.001*(0!==e.deltaY?e.deltaY:e.deltaX))),l=Math.max(.1,Math.min(10,t.transform.scale*r)),n={...t.transform,scale:l};return E({...t,transform:n}),setTimeout(()=>{if(m.current&&p.current&&o&&i){let e=N();if(e&&Math.abs(e.transform.scale-p.current.scale)>.01){let t=p.current.initialState,r={...e};o({description:"Scale selection",undo:()=>E(t),redo:()=>E(r)})}m.current=!1,p.current=null}},150),!0},[N,E,o,i]),H=(0,c.useCallback)(()=>{let e=N();return e?{sel:e.dimensions,offset:e.transform.offset,scale:e.transform.scale,rotation:e.transform.rotation}:null},[N]);return{tintOverlayRef:u,updateFromViewport:z,forceRedraw:D,markDirty:P,setSelectionDimensions:L,handleSelectionPointerDown:O,handleSelectionPointerMove:W,handleSelectionPointerUp:U,handleSelectionWheel:F,getSelectionState:H,getSelectionForImage:(0,c.useCallback)(e=>{let t=d.current.get(e);if(t)return{sel:t.dimensions,offset:t.transform.offset,scale:t.transform.scale,rotation:t.transform.rotation};let r=M(e);return r?{sel:r.dimensions,offset:r.transform.offset,scale:r.transform.scale,rotation:r.transform.rotation}:null},[M]),getOverlayMetrics:(0,c.useCallback)(()=>y.current,[])}}({previewRef:m,imageRef:p,getTintOverlay:B,maskVisible:b,selectionVisible:w,selectedImageId:null!=(n=null==(t=i.selectedImage)?void 0:t.id)?n:null,onSelectionChange:f,onPushUndo:z}),{viewportState:ei,isViewportDefault:es,handlePointerDown:eo,handlePointerMove:ec,handlePointerUp:eu,handleWheel:ed,resetViewport:eh,cancelPan:ef}=function(e){let{imageRef:t,previewRef:r,onPanningChange:l,onViewportUpdate:n}=e,[a,i]=(0,c.useState)(D),s=(0,c.useRef)(a),o=(0,c.useRef)(D()),u=(0,c.useRef)(null),d=(0,c.useRef)(null),h=(0,c.useCallback)(()=>{null===d.current&&(d.current=requestAnimationFrame(()=>{d.current=null,i({...s.current})}))},[]),f=(0,c.useCallback)(e=>{s.current={scale:e.scale,offset:{...e.offset}};let r=t.current;if(r){try{r.draggable=!1}catch(e){}let{scale:e,offset:t}=s.current;r.style.transform="translate3d(".concat(t.x,"px, ").concat(t.y,"px, 0) scale(").concat(e,")")}null==n||n({...s.current}),h()},[t,n,h]),m=(0,c.useCallback)(e=>{f("function"==typeof e?e(s.current):e)},[f]),p=(0,c.useCallback)(()=>{var e;let t=u.current;u.current=null,t&&(null==(e=r.current)?void 0:e.hasPointerCapture(t.pointerId))&&r.current.releasePointerCapture(t.pointerId),null==l||l(!1)},[l,r]),g=(0,c.useCallback)(e=>0===e.button&&!!r.current&&(e.preventDefault(),r.current.setPointerCapture(e.pointerId),u.current={pointerId:e.pointerId,startX:e.clientX,startY:e.clientY,startOffset:{...s.current.offset}},null==l||l(!0),!0),[l,r]),v=(0,c.useCallback)(e=>{let t=u.current;return!!t&&t.pointerId===e.pointerId&&(e.preventDefault(),m({scale:s.current.scale,offset:{x:t.startOffset.x+(e.clientX-t.startX),y:t.startOffset.y+(e.clientY-t.startY)}}),!0)},[m]),y=(0,c.useCallback)(e=>{var t;return(null==(t=u.current)?void 0:t.pointerId)===e.pointerId&&(p(),!0)},[p]),x=(0,c.useCallback)(e=>{var t;let l=null==(t=r.current)?void 0:t.getBoundingClientRect();if(!l)return;e.preventDefault();let n=e.clientX-l.left,a=e.clientY-l.top;m(t=>{let r=Math.exp(-(.0015*(0!==e.deltaY?e.deltaY:e.deltaX))),l=Math.min(6,Math.max(.4,t.scale*r));if(l===t.scale)return t;let i=l/t.scale;return{scale:l,offset:{x:n-i*(n-t.offset.x),y:a-i*(a-t.offset.y)}}})},[r,m]),b=(0,c.useCallback)(()=>{p();let e=r.current;if(!e){let e=D();o.current=e,f(e);return}let t=e.getBoundingClientRect(),l=D(),n=t.width*(1-l.scale)*.5,a=t.height*(1-l.scale)*.5,i={scale:l.scale,offset:{x:n,y:a}};o.current=i,f(i)},[f,p,r]);(0,c.useEffect)(()=>{s.current=a},[a]),(0,c.useEffect)(()=>{let e=r.current;if(!e)return;let t=e=>e.preventDefault();return e.addEventListener("dragstart",t),()=>e.removeEventListener("dragstart",t)},[r]),(0,c.useEffect)(()=>()=>{null!==d.current&&cancelAnimationFrame(d.current),p()},[p]);let k=(0,c.useMemo)(()=>{var e;let{scale:t,offset:r}=a,l=null!=(e=o.current)?e:D();return 1e-4>Math.abs(t-l.scale)&&.5>Math.abs(r.x-l.offset.x)&&.5>Math.abs(r.y-l.offset.y)},[a]);return{viewportState:a,viewportRef:s,isViewportDefault:k,handlePointerDown:g,handlePointerMove:v,handlePointerUp:y,handleWheel:x,resetViewport:b,cancelPan:p}}({imageRef:p,previewRef:m,onPanningChange:d,onViewportUpdate:Z}),em=null!=(a=null==(r=i.selectedImage)?void 0:r.id)?a:null,ep=(0,c.useRef)(null);(0,c.useEffect)(()=>{try{var e;let t=null!=(e="function"==typeof er?er():null)?e:null;f(t)}catch(e){f(null)}},[em,er]),(0,c.useEffect)(()=>{M.current.length=0,N.current.length=0,T(!1)},[em]);let eg=(0,c.useCallback)(e=>{if(0!==e.button&&2!==e.button)return;let t=e.pointerId;if(e.shiftKey){g.current.set(t,"pan"),eo(e);let r=m.current;r&&r.classList.add("image-workspace__preview--force-grab");return}if(U(e,s)){g.current.set(t,"mask"),2===e.button&&("erase"===s||"restore"===s)&&C("erase"===s?"restore":"erase");return}if("hand"===s){g.current.set(t,"pan"),eo(e);let r=m.current;r&&r.classList.add("image-workspace__preview--force-grab");return}if("translate"===s||"rotate"===s){if(2===e.button){if("rotate"===s){if(Q(e,"translate")){g.current.set(t,"selection"),C("translate");return}}else if("translate"===s&&Q(e,"rotate")){g.current.set(t,"selection"),C("rotate");return}}if(Q(e,s))return void g.current.set(t,"selection");g.current.set(t,"pan"),eo(e);let r=m.current;return void(r&&r.classList.add("image-workspace__preview--force-grab"))}if("none"===s){g.current.set(t,"pan"),eo(e);let r=m.current;r&&r.classList.add("image-workspace__preview--force-grab");return}g.current.set(t,"pan"),eo(e);let r=m.current;r&&r.classList.add("image-workspace__preview--force-grab")},[s,U,eo,Q]),ev=(0,c.useCallback)(e=>{var t;let r=e.pointerId,l=null!=(t=g.current.get(r))?t:"none";!("mask"===l&&F(e))&&("selection"===l&&ee(e)||ec(e))},[F,ec,ee]),ey=(0,c.useCallback)(e=>{var t;let r=e.pointerId,l=null!=(t=g.current.get(r))?t:"none";if("mask"===l&&H(e)){g.current.delete(r);let e=m.current,t=Array.from(g.current.values()).includes("pan");e&&!t&&e.classList.remove("image-workspace__preview--force-grab"),C(null);return}if("selection"===l&&et(e)){g.current.delete(r),C(null);return}eu(e),g.current.delete(r);let n=m.current,a=Array.from(g.current.values()).includes("pan");n&&!a&&n.classList.remove("image-workspace__preview--force-grab")},[H,eu,et]);(0,c.useEffect)(()=>{em?(eh(),G()):$()},[G,$,eh,em]),(0,c.useEffect)(()=>{ef(),V(),d(!1),g.current.clear()},[s,ef,V]),(0,c.useEffect)(()=>{let e=e=>{v.current=e,x(e);let t=m.current;if(t)if(e?t.classList.add("image-workspace__preview--modifier"):t.classList.remove("image-workspace__preview--modifier"),e){let e=Array.from(g.current.values()).includes("pan");t.style.cursor=e?"grabbing":"grab"}else t.style.cursor=""},t=t=>{try{if((t.ctrlKey||t.metaKey)&&("z"===t.key||"Z"===t.key)){t.preventDefault(),L();return}}catch(e){}t.shiftKey&&e(!0)},r=t=>{t.shiftKey||e(!1)},l=()=>e(!1);return window.addEventListener("keydown",t),window.addEventListener("keyup",r),window.addEventListener("blur",l),()=>{window.removeEventListener("keydown",t),window.removeEventListener("keyup",r),window.removeEventListener("blur",l),e(!1)}},[m,L]),(0,c.useEffect)(()=>{try{G()}catch(e){}try{Z(ei)}catch(e){}},[b,G,Z,ei]),(0,c.useEffect)(()=>{try{G()}catch(e){}try{Z(ei)}catch(e){}},[w,G,Z,ei]),(0,c.useEffect)(()=>{let e=m.current;if(e)return"none"===s?e.classList.add("image-workspace__preview--none"):e.classList.remove("image-workspace__preview--none"),()=>e.classList.remove("image-workspace__preview--none")},[m,s]),(0,c.useEffect)(()=>{if(!em)return;let e=p.current,t=K.current;G(),(()=>{if(e){if(!(null==X?void 0:X())){t&&(t.style.opacity="0");return}if(b){e&&(e.style.opacity=""),t&&(t.style.opacity="1"),G();try{Z(ei)}catch(e){}return}e&&(e.style.opacity="0");try{t&&(t.style.opacity="1")}catch(e){}}})()},[G,Y,em,b,X,K,Z,ei]),(0,c.useEffect)(()=>{em&&Z(ei)},[em,Z,ei]),(0,c.useEffect)(()=>{let e=()=>{$(),G()};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[G,$]),(0,c.useEffect)(()=>()=>{ef()},[ef]);let ex=(0,c.useMemo)(()=>W(s),[s,W]),eb=(0,c.useMemo)(()=>"translate3d(".concat(ei.offset.x,"px, ").concat(ei.offset.y,"px, 0) scale(").concat(ei.scale,")"),[ei]),ek=(0,c.useCallback)(e=>{let t=!!e.shiftKey;if(("translate"===s||"rotate"===s)&&t)return void ed(e);if(("translate"===s||"rotate"===s)&&"function"==typeof el){let t=e.nativeEvent;try{"rotate"===s&&(C("translate"),ep.current&&window.clearTimeout(ep.current),ep.current=window.setTimeout(()=>{C(null),ep.current=null},250))}catch(e){}if(el(t))return}ed(e)},[s,el,ed]);return{library:i,activeTool:s,setActiveTool:o,handleViewportPointerDown:eg,handleViewportPointerMove:ev,handleViewportPointerUp:ey,handleWheel:ek,previewRef:m,imageRef:p,tintOverlayRef:K,lassoPreview:q,isMaskToolActive:ex,viewportState:ei,isViewportDefault:es,resetViewport:eh,isViewportPanning:u,imageTransform:eb,selectionVisible:w,setSelectionVisible:_,modifierActive:y,tempToolOverride:j,maskVisible:b,setMaskVisible:k,undo:L,redo:O,setSelectionDimensions:J,forceRedraw:G,canUndo:()=>E,canRedo:P,clearHistory:()=>{M.current.length=0,N.current.length=0,T(!1)},getSelectionState:er,getMaskCanvas:X,getSelectionForImage:en,getOverlayMetrics:ea,selectionState:h,overlayVersion:Y}}(),$=(0,c.useRef)(null);(0,c.useEffect)(()=>{try{null==H||H(null!=n?n:null)}catch(e){}try{n&&k()}catch(e){}try{let e=$.current,t=!!(e&&e.length&&e.width),r=!!(n&&n.length&&n.width);r?!t&&r&&q(!0):q(!1),$.current=null!=n?n:null}catch(e){}},[n,null==(t=u.selectedImage)?void 0:t.id]);let J=u.isDragging?"image-workspace__canvas image-workspace__canvas--dragging":"image-workspace__canvas",Q=u.images.length>0&&u.selectedImage;return(0,c.useEffect)(()=>{try{null==a||a(u.images.length);let e=u.images.map(e=>{let t,r,l="function"==typeof Y?Y(e.id):null;if(l){let e=l.getContext("2d");if(e){let r=e.getImageData(0,0,l.width,l.height).data,n=!1,a=Math.min(r.length,4e4),i=Math.max(4,Math.floor(r.length/a));for(let e=0;e<r.length;e+=i){let t=r[e],l=r[e+1],a=r[e+2],i=r[e+3];if(t<250||l<250||a<250||i<255){n=!0;break}}n&&(t=l.toDataURL("image/png"))}}let a={x:.5,y:.5};if("function"==typeof X)try{var i,s,o,c,d,h,f,m;let t=e.id===u.selectedId?Z:X(e.id);if(+(null==t||"object"!=typeof t))n&&n.length&&n.width&&(r={shape:{width:n.width,height:n.length},position:{x:.5,y:.5},scale:1,rotation:{x:0,y:0,z:0,w:1}});else{let e=E(t)?null!=(i=t.sel)?i:null:t;if(e&&null!=e.length&&null!=e.width){let l={x:0,y:0},n=1,i={x:0,y:0,z:0,w:1};E(t)&&(l=null!=(s=t.offset)?s:l,n=null!=(o=t.scale)?o:n,i=null!=(c=t.rotation)?c:i);let u="function"==typeof K?K():null;if(u&&u.width>0&&u.height>0){let e=.5+(null!=(d=l.x)?d:0)/u.width,t=.5+(null!=(h=l.y)?h:0)/u.height;a={x:Math.min(1,Math.max(0,e)),y:Math.min(1,Math.max(0,t))}}else if(800>Math.abs(l.x)&&600>Math.abs(l.y)){let e=.5+(null!=(f=l.x)?f:0)/800,t=.5+(null!=(m=l.y)?m:0)/600;a={x:Math.min(1,Math.max(0,e)),y:Math.min(1,Math.max(0,t))}}r={shape:{width:e.width,height:e.length},position:{x:a.x,y:a.y},scale:n,rotation:i}}}}catch(e){n&&n.length&&n.width&&(r={shape:{width:n.width,height:n.length},position:{x:.5,y:.5},scale:1,rotation:{x:0,y:0,z:0,w:1}})}else n&&n.length&&n.width&&(r={shape:{width:n.width,height:n.length},position:{x:.5,y:.5},scale:1,rotation:{x:0,y:0,z:0,w:1}});return{id:e.id,name:e.name,url:e.url,mask:t,selection:r}});null==i||i(e)}catch(e){}},[u.images,u.selectedId,Y,B,X,K,a,i,n,Z,G]),(0,l.jsxs)("section",{className:J,onDragEnter:u.handleDragEnter,onDragOver:e=>e.preventDefault(),onDragLeave:u.handleDragLeave,onDrop:u.handleDrop,children:[(0,l.jsx)("input",{ref:u.fileInputRef,type:"file",multiple:!0,accept:"image/*",className:"sr-only",onChange:u.handleFileInputChange}),Q||o?Q?(0,l.jsxs)("div",{className:"image-workspace__workspace",children:[(0,l.jsx)(C,{activeTool:h,onToolChange:f,gridEnabled:r,modifierActive:P,tempActiveTool:L,maskVisible:O,onToggleMaskVisible:W,selectionVisible:V,onToggleSelectionVisible:q,onUndo:U,canUndo:F(),onResetViewport:M,canResetViewport:!j,isReportSubmitting:o}),(0,l.jsx)(d,{previewRef:y,imageRef:x,tintOverlayRef:b,selectedImage:u.selectedImage,imageTransform:z,isViewportPanning:T,isMaskToolActive:_,lassoPreview:w,onPointerDown:m,onPointerMove:p,onPointerUp:g,onWheel:v,children:(0,l.jsx)(N,{images:u.images,selectedId:u.selectedId,onSelect:u.setSelectedId,onRemove:u.removeImage,onAdd:u.handleChooseClick,isReportSubmitting:o})})]}):null:(0,l.jsx)(s,{isDragging:u.isDragging,onChooseClick:u.handleChooseClick,onDragEnter:u.handleDragEnter,onDragLeave:u.handleDragLeave,onDrop:u.handleDrop})]})}r(8043);var z=r(854),P=r(9715);let L=[{value:"Any",materials:[]},{value:"Tile",materials:["Ceramic","Porcelain","Stone","Mosaic"]},{value:"Wood",materials:["Oak","Maple","Walnut","Bamboo"]},{value:"Vinyl",materials:["Luxury Vinyl","Sheet Vinyl","Rigid Core"]},{value:"Laminate",materials:["High Gloss","Textured","Water Resistant"]},{value:"Carpet",materials:["Nylon","Polyester","Wool"]}],O={reportName:"",flooringType:"Any",material:"Any",look:"Any",texture:"Any",finish:"Any",edge:"Any",length:"",width:"",thickness:"",units:"absolute"},W={reportName:!1};function U(e){let{onSubmit:t,onDimensionsChange:r,onDimensionsValues:n,imageCount:a=0,onProgressComplete:i,onSubmissionStateChange:s}=e,[o,u]=(0,c.useState)(O),{user:d}=(0,z.A)(),[h,f]=(0,c.useState)(W),[m,p]=(0,c.useState)(!1),[g,v]=(0,c.useState)(!1),[y,x]=(0,c.useState)(null),[b,k]=(0,c.useState)(0),w=(0,c.useRef)(null),_=(0,c.useRef)(null),j=(0,c.useMemo)(()=>L.find(e=>e.value===o.flooringType),[o.flooringType]),C=(0,c.useMemo)(()=>j&&0!==j.materials.length?j.materials:[],[j]),M=/^\d*(?:\.\d*)?$/,N=(e,t)=>{if(""===t)return void u(t=>({...t,[e]:""}));M.test(t)&&u(r=>({...r,[e]:t}))};(0,c.useEffect)(()=>{try{null==r||r(""!==o.length&&""!==o.width);let e=""===o.length?null:Number.parseFloat(o.length),t=""===o.width?null:Number.parseFloat(o.width),l=""===o.thickness?null:Number.parseFloat(o.thickness);null==n||n({length:e,width:t,thickness:l})}catch(e){}},[o.length,o.width,o.thickness,r,n]),(0,c.useEffect)(()=>{(null!=a?a:0)>0&&y&&y.includes("Please add at least one image")&&x(null)},[a,y]),(0,c.useEffect)(()=>()=>{_.current&&(clearInterval(_.current),_.current=null)},[]);let R=(0,c.useCallback)(()=>{_.current&&(clearInterval(_.current),_.current=null),k(100),setTimeout(()=>{v(!1),k(0)},500)},[]);(0,c.useEffect)(()=>{null==i||i(R)},[i,R]),(0,c.useEffect)(()=>{null==s||s(g)},[g,s]);let S=h.reportName&&!m&&""===o.reportName.trim(),I=S?"report-name-error":void 0,A="relative"===o.units&&(""===o.length.trim()||""===o.width.trim()),D=A?"dimensions-error":void 0,E=""!==o.reportName.trim()&&(null!=a?a:0)>0&&("absolute"===o.units||""!==o.length.trim()&&""!==o.width.trim());return(0,l.jsxs)("div",{className:"search-filters",children:[(0,l.jsx)("div",{className:"search-filters__header search-filters__header--strip-top",children:(0,l.jsxs)("h3",{className:"search-filters__title",children:[(0,l.jsx)(P.A,{className:"w-4 h-4"}),"New Report"]})}),(0,l.jsxs)("div",{className:"search-filters__content",children:[(0,l.jsxs)("div",{className:"search-filters__section",children:[(0,l.jsxs)("h4",{className:"search-filters__section-title",children:["Report Name ",(0,l.jsx)("span",{className:"form-field__required-asterisk",children:"*"})]}),(0,l.jsxs)("div",{className:"search-filters__field search-filters__field--vertical",children:[(0,l.jsx)("input",{id:"report-name",ref:w,value:o.reportName,onChange:e=>{let t=e.target.value;u(e=>({...e,reportName:t})),f(e=>({...e,reportName:!1}))},placeholder:"Enter report name",onFocus:()=>{p(!0)},onBlur:()=>{p(!1),f(e=>({...e,reportName:!0}))},"aria-invalid":S,"aria-describedby":I,className:"form-control".concat(S?" form-control--error":"")}),S&&(0,l.jsx)("p",{className:"form-field__hint",id:I,role:"alert",children:"Please enter a report name."})]})]}),(0,l.jsxs)("div",{className:"search-filters__section",children:[(0,l.jsx)("h4",{className:"search-filters__section-title",children:"Category"}),(0,l.jsxs)("div",{className:"search-filters__field",children:[(0,l.jsx)("label",{htmlFor:"flooring-type",className:"search-filters__label",children:"Type"}),(0,l.jsx)("select",{id:"flooring-type",value:o.flooringType,onChange:e=>{var t;return t=e.target.value,void u(e=>({...e,flooringType:t,material:"Any"}))},className:"form-control select-control",children:L.map(e=>(0,l.jsx)("option",{value:e.value,children:e.value},e.value))})]}),(0,l.jsxs)("div",{className:"search-filters__field",children:[(0,l.jsx)("label",{htmlFor:"flooring-material",className:"search-filters__label",children:"Material"}),(0,l.jsxs)("select",{id:"flooring-material",value:o.material,onChange:e=>{var t;return t=e.target.value,void u(e=>({...e,material:t}))},className:"form-control select-control",children:[(0,l.jsx)("option",{value:"Any",children:"Any"}),C.map(e=>(0,l.jsx)("option",{value:e,children:e},e))]})]})]}),(0,l.jsxs)("div",{className:"search-filters__section",children:[(0,l.jsx)("h4",{className:"search-filters__section-title",children:"Dimensions"}),(0,l.jsxs)("div",{className:"search-filters__field",children:[(0,l.jsxs)("label",{htmlFor:"length",className:"search-filters__label",children:["Length","absolute"===o.units?" (in)":"","relative"===o.units&&(0,l.jsx)("span",{className:"form-field__required-asterisk",children:" *"})]}),(0,l.jsx)("input",{id:"length",type:"text",inputMode:"decimal",pattern:"^\\d*(?:\\.\\d*)?$",value:o.length,onChange:e=>N("length",e.target.value),"aria-invalid":"relative"===o.units&&""===o.length.trim(),"aria-describedby":D,className:"form-control".concat("relative"===o.units&&""===o.length.trim()?" form-control--error":"")})]}),(0,l.jsxs)("div",{className:"search-filters__field",children:[(0,l.jsxs)("label",{htmlFor:"width",className:"search-filters__label",children:["Width","absolute"===o.units?" (in)":"","relative"===o.units&&(0,l.jsx)("span",{className:"form-field__required-asterisk",children:" *"})]}),(0,l.jsx)("input",{id:"width",type:"text",inputMode:"decimal",pattern:"^\\d*(?:\\.\\d*)?$",value:o.width,onChange:e=>N("width",e.target.value),"aria-invalid":"relative"===o.units&&""===o.width.trim(),"aria-describedby":D,className:"form-control".concat("relative"===o.units&&""===o.width.trim()?" form-control--error":"")})]}),A&&(0,l.jsx)("div",{className:"search-filters__field search-filters__field--vertical",children:(0,l.jsx)("p",{className:"form-field__hint",id:D,role:"alert",children:"Both length and width are required when using relative units."})}),(0,l.jsxs)("div",{className:"search-filters__field",children:[(0,l.jsx)("label",{htmlFor:"thickness",className:"search-filters__label",children:"Depth (mm)"}),(0,l.jsx)("input",{id:"thickness",type:"text",inputMode:"decimal",pattern:"^\\d*(?:\\.\\d*)?$",value:o.thickness,onChange:e=>N("thickness",e.target.value),className:"form-control"})]}),(0,l.jsxs)("div",{className:"form-field form-field--inline",role:"radiogroup","aria-labelledby":"units-label",children:[(0,l.jsx)("span",{id:"units-label",className:"form-field__label form-field__label--secondary",children:"Units"}),(0,l.jsxs)("div",{className:"form-radio-group",children:[(0,l.jsxs)("label",{className:"form-radio",children:[(0,l.jsx)("input",{type:"radio",name:"units",value:"absolute",checked:"absolute"===o.units,onChange:()=>u(e=>({...e,units:"absolute"}))}),(0,l.jsx)("span",{children:"Absolute"})]}),(0,l.jsxs)("label",{className:"form-radio",children:[(0,l.jsx)("input",{type:"radio",name:"units",value:"relative",checked:"relative"===o.units,onChange:()=>u(e=>({...e,units:"relative"}))}),(0,l.jsx)("span",{children:"Relative"})]})]})]})]}),(0,l.jsxs)("div",{className:"search-filters__section",children:[(0,l.jsxs)("h4",{className:"search-filters__section-title",children:["Reference Images ",(0,l.jsx)("span",{className:"form-field__required-asterisk",children:"*"})]}),(0,l.jsxs)("div",{className:"search-filters__field search-filters__field--vertical",children:[(null!=a?a:0)===0&&(0,l.jsx)("p",{className:"form-field__hint",children:"Add images using the workspace on the right. At least one image is required."}),a>0&&(0,l.jsxs)("p",{className:"form-field__hint",style:{color:"var(--text-subtle)"},children:[a," image",1!==a?"s":""," added"]})]})]}),(0,l.jsxs)("div",{className:"search-filters__section",children:[(0,l.jsx)("h4",{className:"search-filters__section-title",children:"Attributes"}),(0,l.jsxs)("div",{className:"search-filters__field",children:[(0,l.jsx)("label",{htmlFor:"look",className:"search-filters__label",children:"Look"}),(0,l.jsxs)("select",{id:"look",value:o.look,onChange:e=>u(t=>({...t,look:e.target.value})),className:"form-control select-control",children:[(0,l.jsx)("option",{value:"Any",children:"Any"}),(0,l.jsx)("option",{value:"Modern",children:"Modern"}),(0,l.jsx)("option",{value:"Rustic",children:"Rustic"}),(0,l.jsx)("option",{value:"Industrial",children:"Industrial"}),(0,l.jsx)("option",{value:"Traditional",children:"Traditional"})]})]}),(0,l.jsxs)("div",{className:"search-filters__field",children:[(0,l.jsx)("label",{htmlFor:"texture",className:"search-filters__label",children:"Texture"}),(0,l.jsxs)("select",{id:"texture",value:o.texture,onChange:e=>u(t=>({...t,texture:e.target.value})),className:"form-control select-control",children:[(0,l.jsx)("option",{value:"Any",children:"Any"}),(0,l.jsx)("option",{value:"Smooth",children:"Smooth"}),(0,l.jsx)("option",{value:"Hand-scraped",children:"Hand-scraped"}),(0,l.jsx)("option",{value:"Wire-brushed",children:"Wire-brushed"}),(0,l.jsx)("option",{value:"Textured",children:"Textured"})]})]}),(0,l.jsxs)("div",{className:"search-filters__field",children:[(0,l.jsx)("label",{htmlFor:"finish",className:"search-filters__label",children:"Finish"}),(0,l.jsxs)("select",{id:"finish",value:o.finish,onChange:e=>u(t=>({...t,finish:e.target.value})),className:"form-control select-control",children:[(0,l.jsx)("option",{value:"Any",children:"Any"}),(0,l.jsx)("option",{value:"Matte",children:"Matte"}),(0,l.jsx)("option",{value:"Satin",children:"Satin"}),(0,l.jsx)("option",{value:"Gloss",children:"Gloss"}),(0,l.jsx)("option",{value:"UV",children:"UV"})]})]}),(0,l.jsxs)("div",{className:"search-filters__field",children:[(0,l.jsx)("label",{htmlFor:"edge",className:"search-filters__label",children:"Edge"}),(0,l.jsxs)("select",{id:"edge",value:o.edge,onChange:e=>u(t=>({...t,edge:e.target.value})),className:"form-control select-control",children:[(0,l.jsx)("option",{value:"Any",children:"Any"}),(0,l.jsx)("option",{value:"Square",children:"Square"}),(0,l.jsx)("option",{value:"Beveled",children:"Beveled"}),(0,l.jsx)("option",{value:"Micro-bevel",children:"Micro-bevel"}),(0,l.jsx)("option",{value:"Eased",children:"Eased"})]})]})]}),y&&(0,l.jsx)("div",{className:"form-field__hint",role:"alert",children:y})]}),(0,l.jsx)("div",{className:"search-filters__footer",children:(0,l.jsx)("form",{id:"report-form",onSubmit:e=>{if(e.preventDefault(),""===o.reportName.trim()){f(e=>({...e,reportName:!0})),p(!1);return}if("relative"!==o.units||""!==o.length.trim()&&""!==o.width.trim()){if((null!=a?a:0)===0)return void x("Please add at least one image before creating a report.");v(!0),x(null),k(0);_.current=setInterval(()=>{k(e=>{let t=e+.2857142857142857;return t>=90?Math.min(90,e+.02857142857142857):t})},100);try{var r;let e=null!=(r=null==d?void 0:d.id)?r:"guest";null==t||t({...o,author:e})}catch(e){x("Failed to create report. Please try again."),_.current&&(clearInterval(_.current),_.current=null),v(!1),k(0)}}},children:(0,l.jsx)("button",{type:"submit",className:"button button--primary search-filters__search-btn",disabled:!E||g,"aria-disabled":!E||g,children:g?(0,l.jsxs)("svg",{className:"button-spinner",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":!0,children:[(0,l.jsx)("circle",{cx:"12",cy:"12",r:"10",stroke:"#ffffff33",strokeWidth:"4"}),(0,l.jsx)("path",{d:"M22 12A10 10 0 0 1 12 22",stroke:"#ffffff",strokeWidth:"4",strokeLinecap:"round"})]}):"Create Report"})})}),g&&(0,l.jsx)("div",{className:"report-creation-overlay",children:(0,l.jsx)("div",{className:"report-creation-modal",children:(0,l.jsxs)("div",{className:"report-creation-content",children:[(0,l.jsx)("div",{className:"report-creation-icon",children:(0,l.jsx)(P.A,{size:48})}),(0,l.jsx)("h3",{className:"report-creation-title",children:"Creating Your Report"}),(0,l.jsx)("p",{className:"report-creation-message",children:"We're analyzing your images and preparing your material matches. This may take up to 30 seconds."}),(0,l.jsxs)("div",{className:"progress-container",children:[(0,l.jsx)("div",{className:"progress-bar",children:(0,l.jsx)("div",{className:"progress-fill",style:{width:"".concat(b,"%")}})}),(0,l.jsxs)("div",{className:"progress-text",children:[Math.round(b),"%"]})]}),(0,l.jsx)("p",{className:"report-creation-subtitle",children:"Please don't close this window or navigate away."})]})})})]})}var F=r(7382);async function H(e,t){let r,l,n="absolute"===e.units?"in":"none",a=""===e.length?void 0:Number.parseFloat(e.length),i=""===e.width?void 0:Number.parseFloat(e.width),s=""===e.thickness?void 0:Number.parseFloat(e.thickness);if(void 0!==a&&void 0!==i)if("relative"===e.units){let[e,t]=function(e,t){let r=Math.round(1e3*e),l=Math.round(1e3*t),n=function e(t,r){return 0===r?t:e(r,t%r)}(r,l),a=r/n,i=l/n;return a>=i?[a,i]:[i,a]}(a,i);r=e,l=t}else r=Math.max(a,i),l=Math.min(a,i);else r=void 0!==a?a:void 0!==i?i:void 0,l=void 0;let o={id:"",brand:"",series:void 0,model:"",images:t.map(e=>{var t,r;return{id:"",url:e.url,mask:null!=(t=e.mask)?t:void 0,selection:null!=(r=e.selection)?r:void 0}}),category:{type:e.flooringType&&"Any"!==e.flooringType?e.flooringType:void 0,material:e.material&&"Any"!==e.material?e.material:void 0,look:e.look&&"Any"!==e.look?e.look:void 0,texture:e.texture&&"Any"!==e.texture?e.texture:void 0,finish:e.finish&&"Any"!==e.finish?e.finish:void 0,edge:e.edge&&"Any"!==e.edge?e.edge:void 0},formats:[{length:void 0===r?void 0:{val:r,unit:n},width:void 0===l?void 0:{val:l,unit:n},thickness:void 0===s||Number.isNaN(s)?void 0:{val:s,unit:"mm"},vendors:[]}]},c={title:e.reportName,author:e.author,reference:o};return{id:await (0,F.LU)(c.title,c.reference),date:new Date().toISOString(),...c}}function V(){let e=(0,n.useRouter)(),[t,r]=(0,c.useState)(!1),[a,i]=(0,c.useState)({length:null,width:null,thickness:null}),[s,o]=(0,c.useState)(0),[u,d]=(0,c.useState)([]),[h,f]=(0,c.useState)(!1),m=(0,c.useRef)(null),p=(0,c.useCallback)(e=>r(e),[]),g=(0,c.useCallback)(e=>i(e),[]);return(0,l.jsxs)("div",{className:"report-create",children:[(0,l.jsx)("aside",{className:"report-create__sidebar",children:(0,l.jsx)("div",{className:"report-create__form",children:(0,l.jsx)(U,{onDimensionsChange:p,onDimensionsValues:g,imageCount:s,onProgressComplete:e=>{m.current=e},onSubmissionStateChange:f,onSubmit:async t=>{try{let r=await H(t,u);setTimeout(()=>{var t;null==(t=m.current)||t.call(m),e.push("/fetch?report=".concat(r.id||"new"))},0)}catch(e){console.error("Failed to create report",e),setTimeout(()=>{var e;null==(e=m.current)||e.call(m)},0)}}})})}),(0,l.jsx)(T,{gridEnabled:t,dimensions:a,onImagesChange:o,onImages:d,isReportSubmitting:h})]})}},3540:(e,t,r)=>{"use strict";r.d(t,{i:()=>s});var l=r(3280),n=r(87);let a=["mousedown","mousemove","keypress","scroll","touchstart","click"];class i{initialize(e,t){this.isClient&&!this.isInitialized&&(this.onSessionExpired=e||null,this.onRefreshError=t||null,this.isInitialized=!0,this.setupActivityTracking(),this.startRefreshTimer(),console.log("SessionManager initialized"))}cleanup(){this.isClient&&(a.forEach(e=>{document.removeEventListener(e,this.updateActivity,!0)}),this.refreshTimer&&(clearInterval(this.refreshTimer),this.refreshTimer=null),this.isInitialized=!1,console.log("SessionManager cleaned up"))}setupActivityTracking(){this.isClient&&a.forEach(e=>{document.addEventListener(e,this.updateActivity,!0)})}isInactive(){return Date.now()-this.lastActivityTime>18e5}needsRefresh(){let e=l.LP.accessToken;if(!e)return!1;try{let t=JSON.parse(atob(e.split(".")[1]));return 1e3*t.exp-Date.now()<6e5}catch(e){return!1}}startRefreshTimer(){this.isClient&&(this.refreshTimer=setInterval(async()=>{await this.checkAndRefreshSession()},3e5))}async checkAndRefreshSession(){try{if(!l.LP.accessToken||!l.LP.refreshToken)return;if(this.isInactive()){console.log("User inactive for too long, ending session"),this.endSession();return}if(l.LP.expired||this.needsRefresh()){if(console.log("Token needs refresh, attempting refresh..."),!(await (0,n.Ow)()).body){console.log("Token refresh failed"),this.handleRefreshError();return}console.log("Token refreshed successfully")}}catch(e){console.error("Error during session check:",e),this.handleRefreshError()}}handleRefreshError(){this.onRefreshError?this.onRefreshError():this.endSession()}endSession(){l.LP.clear(),this.onSessionExpired&&this.onSessionExpired()}async manualRefresh(){try{if(!l.LP.refreshToken)return!1;return!!(await (0,n.Ow)()).body}catch(e){return console.error("Manual refresh failed:",e),!1}}resetActivity(){this.lastActivityTime=Date.now()}getTimeUntilInactive(){return Math.max(0,18e5-(Date.now()-this.lastActivityTime))}isSessionActive(){return!this.isInactive()&&!l.LP.expired&&!!l.LP.accessToken}constructor(){this.lastActivityTime=Date.now(),this.refreshTimer=null,this.onSessionExpired=null,this.onRefreshError=null,this.isInitialized=!1,this.isClient=!0,this.updateActivity=()=>{this.lastActivityTime=Date.now()}}}let s=new i},4582:(e,t,r)=>{"use strict";r.d(t,{AuthProvider:()=>d,Z:()=>h});var l=r(5155),n=r(2115),a=r(63),i=r(3280),s=r(87),o=r(3540);let c=(0,n.createContext)(void 0),u={id:"demo-user-1",name:"Demo User",email:"demo@k9search.com",avatarUrl:void 0};function d(e){let{children:t}=e,[r,d]=(0,n.useState)({user:null,loading:!0}),[h,f]=(0,n.useState)(!1),m=(0,a.useRouter)();(0,n.useEffect)(()=>{f(!0)},[]);let p=(0,n.useCallback)(()=>{console.log("Session expired, redirecting to login"),d({user:null,loading:!1}),m.push("/")},[m]),g=(0,n.useCallback)(()=>{console.log("Token refresh failed, redirecting to login"),d({user:null,loading:!1}),m.push("/")},[m]);async function v(e,t){let r=await (0,s.iD)(e,t);if(200===r.status){let t=i.LP.idToken,s=t?(0,i.xI)(t):null;if(s){var l,n,a;d({user:{id:String(null!=(l=s.sub)?l:""),name:String(null!=(a=null!=(n=s.name)?n:s["cognito:username"])?a:e),email:"string"==typeof s.email?s.email:void 0},loading:!1})}else d({user:null,loading:!1});return{ok:!0,status:r.status}}return{ok:!1,status:r.status}}return(0,n.useEffect)(()=>{let e=!1;return async function(){if(h)try{var t,r,l,n,a,o;let c=i.LP.all;if(c&&!i.LP.expired){let n=(0,i.xI)(c.idToken);if(n&&!e)return void d({user:{id:String(null!=(t=n.sub)?t:""),name:String(null!=(l=null!=(r=n.name)?r:n["cognito:username"])?l:""),email:"string"==typeof n.email?n.email:void 0},loading:!1})}if(i.LP.refreshToken)try{let t=(0,s.Ow)(),r=new Promise((e,t)=>setTimeout(()=>t(Error("Refresh timeout")),5e3)),l=await Promise.race([t,r]);if(l&&"object"==typeof l&&"body"in l&&l.body&&i.LP.idToken){let t=(0,i.xI)(i.LP.idToken);if(t&&!e)return void d({user:{id:String(null!=(n=t.sub)?n:""),name:String(null!=(o=null!=(a=t.name)?a:t["cognito:username"])?o:""),email:"string"==typeof t.email?t.email:void 0},loading:!1})}}catch(e){console.log("Refresh failed or timed out:",e)}e||d({user:null,loading:!1})}catch(t){console.error("Auth initialization error:",t),e||d({user:null,loading:!1})}}(),()=>{e=!0}},[h]),(0,n.useEffect)(()=>{if(h)return r.user&&!r.loading?o.i.initialize(p,g):o.i.cleanup(),()=>{o.i.cleanup()}},[r.user,r.loading,h,p,g]),(0,l.jsx)(c.Provider,{value:{user:r.user,loading:r.loading,signInWithDummy:function(){d({user:u,loading:!1})},signIn:v,signOut:function(){i.LP.clear(),o.i.cleanup(),d({user:null,loading:!1}),m.push("/")}},children:t})}function h(){let e=(0,n.useContext)(c);if(!e)throw Error("useAuthContext must be used within an AuthProvider");return e}},5993:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});let l=(0,r(1847).A)("house",[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"r6nss1"}]])},8043:()=>{},9715:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});let l=(0,r(1847).A)("file-text",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]])}},e=>{e.O(0,[964,780,382,441,255,358],()=>e(e.s=870)),_N_E=e.O()}]);