(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{63:(e,t,r)=>{"use strict";var s=r(7260);r.o(s,"usePathname")&&r.d(t,{usePathname:function(){return s.usePathname}}),r.o(s,"useRouter")&&r.d(t,{useRouter:function(){return s.useRouter}}),r.o(s,"useSearchParams")&&r.d(t,{useSearchParams:function(){return s.useSearchParams}})},87:(e,t,r)=>{"use strict";r.d(t,{iD:()=>l,Ow:()=>o,ns:()=>u});var s=r(3280),n=function(e){return e.SUCCESS="SUCCESS",e.RESET="RESET",e.DENIED="DENIED",e}({});let i="".concat("https://824xuvy567.execute-api.us-east-2.amazonaws.com/securek9","/auth");function a(e,t,r){return{status:e,body:t,error:r}}async function l(e,t){try{var r,l;let o=await fetch("".concat(i,"/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})}),u=null!=(r=await o.json())?r:{};if(200===o.status&&u.accessToken&&u.idToken){let t={idToken:u.idToken,accessToken:u.accessToken,refreshToken:u.refreshToken,username:e};return s.LP.set(t),a(200,n.SUCCESS)}if(202===o.status&&u.session&&u.username)return s.LP.setResetSession(u.username,u.session),a(202,n.RESET);return a(o.status,n.DENIED,null!=(l=null==u?void 0:u.message)?l:"")}catch(t){let e=t&&"object"==typeof t&&"message"in t&&"string"==typeof t.message?t.message:String(t);return a(500,n.DENIED,e)}}async function o(){let e=s.LP.refreshToken,t=s.LP.username;if(!e||!t)return a(401,!1,"Missing refresh token or username");try{var r;let n=await fetch("".concat(i,"/refresh"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e,username:t})}),l=null!=(r=await n.json())?r:{};if(200===n.status&&l.accessToken&&l.idToken)return s.LP.set({idToken:l.idToken,accessToken:l.accessToken,refreshToken:e,username:t}),a(200,!0);return(401===n.status||403===n.status)&&s.LP.clear(),a(n.status,!1,(null==l?void 0:l.message)||"Token refresh failed")}catch(e){return a(500,!1,e&&"object"==typeof e&&"message"in e&&"string"==typeof e.message?e.message:String(e))}}async function u(e){let t=s.LP.idToken;if(t&&!s.LP.expired){let r=await e({Authorization:"Bearer ".concat(t)});if(401===r.status){if((await o()).body){let t=s.LP.idToken;if(t)return e({Authorization:"Bearer ".concat(t)})}s.LP.clear()}return r}let r=await o();if(!r.body)return s.LP.clear(),{status:r.status,body:null,error:r.error||"Authentication failed"};let n=s.LP.idToken;return e(n?{Authorization:"Bearer ".concat(n)}:{})}},854:(e,t,r)=>{"use strict";r.d(t,{A:()=>n});var s=r(4582);function n(){return(0,s.Z)()}},3280:(e,t,r)=>{"use strict";r.d(t,{LP:()=>l,xI:()=>i});let s="k9:auth:tokens",n="k9:auth:reset";function i(e){try{let t=e.split(".");if(t.length<2)return null;let r=t[1],s=atob(r.replace(/-/g,"+").replace(/_/g,"/"));return JSON.parse(decodeURIComponent(escape(s)))}catch(e){return null}}class a{set(e){this.isClient&&(localStorage.setItem(s,JSON.stringify(e)),localStorage.removeItem(n))}setResetSession(e,t){this.isClient&&(localStorage.setItem(n,JSON.stringify({username:e,session:t})),localStorage.removeItem(s))}clear(){this.isClient&&(localStorage.removeItem(s),localStorage.removeItem(n))}clearResetSession(){this.isClient&&localStorage.removeItem(n)}get all(){if(!this.isClient)return null;let e=localStorage.getItem(s);return e?JSON.parse(e):null}get accessToken(){var e,t;return null!=(t=null==(e=this.all)?void 0:e.accessToken)?t:null}get idToken(){var e,t;return null!=(t=null==(e=this.all)?void 0:e.idToken)?t:null}get refreshToken(){var e,t;return null!=(t=null==(e=this.all)?void 0:e.refreshToken)?t:null}get username(){var e,t;return null!=(t=null==(e=this.all)?void 0:e.username)?t:null}get resetSession(){if(!this.isClient)return null;let e=localStorage.getItem(n);if(!e)return null;try{return JSON.parse(e).session}catch(e){return null}}get resetUsername(){if(!this.isClient)return null;let e=localStorage.getItem(n);if(!e)return null;try{return JSON.parse(e).username}catch(e){return null}}get expired(){let e=this.accessToken;if(!e)return!0;let t=i(e);if(!t||!t.exp)return!0;let r=Math.floor(Date.now()/1e3);return t.exp<=r}get invalid(){return!this.idToken||!this.accessToken||!!this.expired&&!this.refreshToken}constructor(){this.isClient=!0}}let l=new a},3540:(e,t,r)=>{"use strict";r.d(t,{i:()=>l});var s=r(3280),n=r(87);let i=["mousedown","mousemove","keypress","scroll","touchstart","click"];class a{initialize(e,t){this.isClient&&!this.isInitialized&&(this.onSessionExpired=e||null,this.onRefreshError=t||null,this.isInitialized=!0,this.setupActivityTracking(),this.startRefreshTimer(),console.log("SessionManager initialized"))}cleanup(){this.isClient&&(i.forEach(e=>{document.removeEventListener(e,this.updateActivity,!0)}),this.refreshTimer&&(clearInterval(this.refreshTimer),this.refreshTimer=null),this.isInitialized=!1,console.log("SessionManager cleaned up"))}setupActivityTracking(){this.isClient&&i.forEach(e=>{document.addEventListener(e,this.updateActivity,!0)})}isInactive(){return Date.now()-this.lastActivityTime>18e5}needsRefresh(){let e=s.LP.accessToken;if(!e)return!1;try{let t=JSON.parse(atob(e.split(".")[1]));return 1e3*t.exp-Date.now()<6e5}catch(e){return!1}}startRefreshTimer(){this.isClient&&(this.refreshTimer=setInterval(async()=>{await this.checkAndRefreshSession()},3e5))}async checkAndRefreshSession(){try{if(!s.LP.accessToken||!s.LP.refreshToken)return;if(this.isInactive()){console.log("User inactive for too long, ending session"),this.endSession();return}if(s.LP.expired||this.needsRefresh()){if(console.log("Token needs refresh, attempting refresh..."),!(await (0,n.Ow)()).body){console.log("Token refresh failed"),this.handleRefreshError();return}console.log("Token refreshed successfully")}}catch(e){console.error("Error during session check:",e),this.handleRefreshError()}}handleRefreshError(){this.onRefreshError?this.onRefreshError():this.endSession()}endSession(){s.LP.clear(),this.onSessionExpired&&this.onSessionExpired()}async manualRefresh(){try{if(!s.LP.refreshToken)return!1;return!!(await (0,n.Ow)()).body}catch(e){return console.error("Manual refresh failed:",e),!1}}resetActivity(){this.lastActivityTime=Date.now()}getTimeUntilInactive(){return Math.max(0,18e5-(Date.now()-this.lastActivityTime))}isSessionActive(){return!this.isInactive()&&!s.LP.expired&&!!s.LP.accessToken}constructor(){this.lastActivityTime=Date.now(),this.refreshTimer=null,this.onSessionExpired=null,this.onRefreshError=null,this.isInitialized=!1,this.isClient=!0,this.updateActivity=()=>{this.lastActivityTime=Date.now()}}}let l=new a},3673:()=>{},3944:e=>{e.exports={style:{fontFamily:"'Geist Mono', 'Geist Mono Fallback'",fontStyle:"normal"},className:"__className_eee913",variable:"__variable_eee913"}},4582:(e,t,r)=>{"use strict";r.d(t,{AuthProvider:()=>d,Z:()=>h});var s=r(5155),n=r(2115),i=r(63),a=r(3280),l=r(87),o=r(3540);let u=(0,n.createContext)(void 0),c={id:"demo-user-1",name:"Demo User",email:"demo@k9search.com",avatarUrl:void 0};function d(e){let{children:t}=e,[r,d]=(0,n.useState)({user:null,loading:!0}),[h,m]=(0,n.useState)(!1),f=(0,i.useRouter)();(0,n.useEffect)(()=>{m(!0)},[]);let p=(0,n.useCallback)(()=>{console.log("Session expired, redirecting to login"),d({user:null,loading:!1}),f.push("/")},[f]),v=(0,n.useCallback)(()=>{console.log("Token refresh failed, redirecting to login"),d({user:null,loading:!1}),f.push("/")},[f]);async function g(e,t){let r=await (0,l.iD)(e,t);if(200===r.status){let t=a.LP.idToken,l=t?(0,a.xI)(t):null;if(l){var s,n,i;d({user:{id:String(null!=(s=l.sub)?s:""),name:String(null!=(i=null!=(n=l.name)?n:l["cognito:username"])?i:e),email:"string"==typeof l.email?l.email:void 0},loading:!1})}else d({user:null,loading:!1});return{ok:!0,status:r.status}}return{ok:!1,status:r.status}}return(0,n.useEffect)(()=>{let e=!1;return async function(){if(h)try{var t,r,s,n,i,o;let u=a.LP.all;if(u&&!a.LP.expired){let n=(0,a.xI)(u.idToken);if(n&&!e)return void d({user:{id:String(null!=(t=n.sub)?t:""),name:String(null!=(s=null!=(r=n.name)?r:n["cognito:username"])?s:""),email:"string"==typeof n.email?n.email:void 0},loading:!1})}if(a.LP.refreshToken)try{let t=(0,l.Ow)(),r=new Promise((e,t)=>setTimeout(()=>t(Error("Refresh timeout")),5e3)),s=await Promise.race([t,r]);if(s&&"object"==typeof s&&"body"in s&&s.body&&a.LP.idToken){let t=(0,a.xI)(a.LP.idToken);if(t&&!e)return void d({user:{id:String(null!=(n=t.sub)?n:""),name:String(null!=(o=null!=(i=t.name)?i:t["cognito:username"])?o:""),email:"string"==typeof t.email?t.email:void 0},loading:!1})}}catch(e){console.log("Refresh failed or timed out:",e)}e||d({user:null,loading:!1})}catch(t){console.error("Auth initialization error:",t),e||d({user:null,loading:!1})}}(),()=>{e=!0}},[h]),(0,n.useEffect)(()=>{if(h)return r.user&&!r.loading?o.i.initialize(p,v):o.i.cleanup(),()=>{o.i.cleanup()}},[r.user,r.loading,h,p,v]),(0,s.jsx)(u.Provider,{value:{user:r.user,loading:r.loading,signInWithDummy:function(){d({user:c,loading:!1})},signIn:g,signOut:function(){a.LP.clear(),o.i.cleanup(),d({user:null,loading:!1}),f.push("/")}},children:t})}function h(){let e=(0,n.useContext)(u);if(!e)throw Error("useAuthContext must be used within an AuthProvider");return e}},5306:(e,t,r)=>{"use strict";r.d(t,{AuthGuard:()=>l});var s=r(5155),n=r(854),i=r(63),a=r(2115);function l(e){let{children:t}=e,{user:r,loading:l}=(0,n.A)(),o=(0,i.useRouter)(),u=(0,i.usePathname)();return((0,a.useEffect)(()=>{if(!l&&"/"!==u&&""!==u&&!r)return void o.push("/")},[r,l,u,o]),l&&"/"!==u&&""!==u)?(0,s.jsx)("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",width:"100vw",position:"fixed",top:0,left:0,fontSize:"1.1rem",color:"var(--text-muted)",overflow:"hidden"},children:"Authenticating..."}):r||"/"===u||""===u?(0,s.jsx)(s.Fragment,{children:t}):(0,s.jsx)("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",width:"100vw",position:"fixed",top:0,left:0,fontSize:"1.1rem",color:"var(--text-muted)",overflow:"hidden"},children:"Redirecting..."})}},6168:e=>{e.exports={style:{fontFamily:"'Geist', 'Geist Fallback'",fontStyle:"normal"},className:"__className_217490",variable:"__variable_217490"}},8474:(e,t,r)=>{"use strict";r.d(t,{ConditionalHeader:()=>o});var s=r(5155),n=r(854),i=r(63),a=r(2115);function l(){let{user:e,loading:t,signOut:r}=(0,n.A)(),l=(0,i.useRouter)(),o=(0,i.usePathname)(),u=(0,i.useSearchParams)(),[c,d]=(0,a.useState)(!1),[h,m]=(0,a.useState)(null),[f,p]=(0,a.useState)(null),[v,g]=(0,a.useState)(!1),x=(0,a.useRef)(null);return(0,a.useEffect)(()=>{g(!0)},[]),(0,a.useEffect)(()=>{let e=e=>{x.current&&!x.current.contains(e.target)&&d(!1)};if(c)return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[c]),(0,a.useEffect)(()=>{if(o.startsWith("/fetch")){let e=u.get("report"),t=u.get("id"),r=u.get("product"),s=e||t;s?(m(s),r?p(r):p(null)):(m(null),p(null))}else m(null),p(null)},[o,u]),(0,s.jsxs)("header",{className:"app-header-universal",children:[(0,s.jsxs)("div",{className:"app-header-universal__left",children:["/dashboard"!==o&&"/dashboard/"!==o&&"/"!==o?(0,s.jsx)("button",{onClick:()=>{if("/create"===o)l.push("/dashboard");else if(o.startsWith("/fetch")){let e=u.get("product"),t=u.get("report");if(e&&t)l.push("/fetch?report=".concat(t));else{if(t&&1)try{sessionStorage.removeItem("report_filters_".concat(t)),sessionStorage.removeItem("report_results_".concat(t)),sessionStorage.removeItem("report_searched_".concat(t))}catch(e){console.warn("Failed to clear report session data:",e)}l.push("/dashboard")}}else l.back()},className:"app-header-universal__back-btn",title:"Go back",children:(0,s.jsx)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{d:"M19 12H5M12 19L5 12L12 5",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}):(0,s.jsx)("div",{className:"app-header-universal__back-btn-spacer"}),(0,s.jsxs)("div",{className:"app-header-universal__logo",children:[(0,s.jsx)("div",{className:"app-header-universal__logo-icon",children:(0,s.jsxs)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,s.jsx)("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",stroke:"currentColor",strokeWidth:"2"}),(0,s.jsx)("path",{d:"M9 9h6v6H9z",fill:"currentColor"})]})}),(0,s.jsx)("h1",{className:"app-header-universal__title",children:"/dashboard"===o||"/dashboard/"===o||"/"===o?"Dashboard":"/create"===o||"/create/"===o?"Create":o.startsWith("/fetch")?u.get("product")?f?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{children:"Compare:"}),(0,s.jsx)("span",{className:"app-header-universal__subtitle",children:f})]}):"Compare":h?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{children:"Fetch:"}),(0,s.jsx)("span",{className:"app-header-universal__subtitle",children:h})]}):"Fetch":o.startsWith("/edit")?"Edit Search":"K9 Search"})]})]}),(0,s.jsxs)("div",{className:"app-header-universal__right",children:[!v||t?(0,s.jsxs)("div",{className:"app-header-universal__user",children:[(0,s.jsx)("span",{className:"app-header-universal__username",children:"Loading..."}),(0,s.jsx)("div",{className:"app-header-universal__avatar skeleton"})]}):e?(0,s.jsx)("div",{className:"app-header-universal__user",children:(0,s.jsxs)("div",{className:"app-header-universal__user-menu",ref:x,children:[(0,s.jsxs)("button",{onClick:()=>d(!c),className:"app-header-universal__user-button",title:"User menu",children:[(0,s.jsx)("span",{className:"app-header-universal__username",children:e.name}),(0,s.jsx)("div",{className:"app-header-universal__avatar",children:e.name.charAt(0).toUpperCase()})]}),c&&(0,s.jsxs)("div",{className:"app-header-universal__user-menu-dropdown",children:[(0,s.jsxs)("div",{className:"app-header-universal__user-info",children:[(0,s.jsx)("strong",{children:e.name}),(0,s.jsx)("span",{children:e.email||"No email"})]}),(0,s.jsx)("hr",{className:"app-header-universal__user-menu-divider"}),(0,s.jsx)("button",{disabled:!0,onClick:()=>{d(!1)},className:"app-header-universal__user-menu-item",title:"Settings (Coming Soon)",children:"Settings"}),(0,s.jsx)("button",{onClick:()=>{r(),d(!1)},className:"app-header-universal__user-menu-item app-header-universal__user-menu-item--danger",children:"Sign Out"})]})]})}):(0,s.jsx)("div",{className:"app-header-universal__user",children:(0,s.jsx)("button",{onClick:()=>l.push("/"),className:"app-header-universal__login-btn",title:"Log in",children:"Log In"})}),(0,s.jsx)("div",{className:"app-header-universal__right-spacer"})]})]})}function o(){let{user:e}=(0,n.A)(),t=(0,i.usePathname)();return e||"/"!==t?(0,s.jsx)(a.Suspense,{fallback:(0,s.jsx)("div",{className:"app-header-universal",style:{height:"64px"}}),children:(0,s.jsx)(l,{})}):null}},8974:(e,t,r)=>{Promise.resolve().then(r.t.bind(r,6168,23)),Promise.resolve().then(r.t.bind(r,3944,23)),Promise.resolve().then(r.t.bind(r,3673,23)),Promise.resolve().then(r.bind(r,5306)),Promise.resolve().then(r.bind(r,8474)),Promise.resolve().then(r.bind(r,9398)),Promise.resolve().then(r.bind(r,4582))},9398:(e,t,r)=>{"use strict";r.d(t,{SessionWarning:()=>l});var s=r(5155),n=r(2115),i=r(3540),a=r(854);function l(e){let{warningThreshold:t=3e5,className:r=""}=e,{user:l}=(0,a.A)(),{timeUntilInactive:o,refreshSession:u}=function(){let[e,t]=(0,n.useState)({isActive:!0,timeUntilInactive:18e5,lastActivity:new Date});(0,n.useEffect)(()=>{let e=()=>{t({isActive:i.i.isSessionActive(),timeUntilInactive:i.i.getTimeUntilInactive(),lastActivity:new Date})};e();let r=setInterval(e,6e4);return()=>clearInterval(r)},[]);let r=async()=>{let e=await i.i.manualRefresh();return e&&i.i.resetActivity(),e};return{...e,refreshSession:r,resetActivity:()=>{i.i.resetActivity()}}}(),[c,d]=(0,n.useState)(!1),[h,m]=(0,n.useState)(!1);(0,n.useEffect)(()=>{if(!l)return void d(!1);d(o>0&&o<t)},[o,t,l]);let f=async()=>{m(!0);try{await u(),d(!1)}catch(e){console.error("Failed to refresh session:",e)}finally{m(!1)}};return c&&l?(0,s.jsxs)("div",{className:"session-warning ".concat(r),style:{position:"fixed",top:"20px",right:"20px",background:"var(--warning-bg, #fff3cd)",border:"1px solid var(--warning-border, #ffeeba)",color:"var(--warning-text, #856404)",padding:"16px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.1)",zIndex:1e3,maxWidth:"300px",fontSize:"14px"},children:[(0,s.jsx)("div",{style:{fontWeight:"600",marginBottom:"8px"},children:"Session Expiring Soon"}),(0,s.jsxs)("div",{style:{marginBottom:"12px"},children:["Your session will expire in ",(e=>{let t=Math.floor(e/6e4),r=Math.floor(e%6e4/1e3);return"".concat(t,":").concat(r.toString().padStart(2,"0"))})(o)," due to inactivity."]}),(0,s.jsx)("button",{onClick:f,disabled:h,style:{background:"var(--primary-color, #007bff)",color:"white",border:"none",padding:"8px 16px",borderRadius:"4px",cursor:h?"not-allowed":"pointer",fontSize:"14px",opacity:h?.6:1},children:h?"Refreshing...":"Stay Logged In"})]}):null}}},e=>{e.O(0,[652,441,255,358],()=>e(e.s=8974)),_N_E=e.O()}]);